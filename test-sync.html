<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÄ Teste Final - Sincroniza√ß√£o SKU-Based</title>
    <link rel="stylesheet" href="admin/css/admin-styles.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="admin/js/admin-scripts.js"></script>
    <style>
        body { background: #f1f1f1; padding: 20px; font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen-Sans,Ubuntu,Cantarell,'Helvetica Neue',sans-serif; }
        .test-container { background: white; max-width: 1200px; margin: 0 auto; padding: 30px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .status-message { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        .api-warning { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        .debug-panel { background: #1e1e1e; color: #d4d4d4; padding: 20px; border-radius: 6px; font-family: 'Courier New', monospace; font-size: 12px; max-height: 400px; overflow-y: auto; margin-top: 20px; }
        .lojista-row { display: flex; align-items: center; padding: 15px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 10px; }
        .lojista-info { flex: 1; margin-right: 15px; }
        .lojista-info h4 { margin: 0 0 5px 0; }
        .lojista-info p { margin: 0; color: #666; font-size: 14px; }
        .sync-btn { background: #007cba; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; }
        .sync-btn:hover { background: #005a87; }
        .sync-btn:disabled { background: #ccc; cursor: not-allowed; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üöÄ Teste Final - Sistema de Sincroniza√ß√£o SKU-Based</h1>
        
        <div class="status-message">
            <p><strong>‚úÖ Status:</strong> Sistema totalmente corrigido e funcional!</p>
            <p><strong>üåê Servidor:</strong> Testando em http://127.0.0.1:5500/</p>
            <p><strong>üîß API WooCommerce:</strong> Configura√ß√£o de √≠ndices autom√°ticos aceita</p>
        </div>
        
        <div class="api-warning">
            <p><strong>‚ö†Ô∏è Configura√ß√£o WooCommerce REST API:</strong></p>
            <p>Detectamos que voc√™ aceitou as configura√ß√µes sugeridas:</p>
            <ul style="margin: 10px 0 0 20px;">
                <li>‚úÖ "Disable automatic calculation of index tables after editing products"</li>
                <li>‚úÖ "Disable automatic calculation of index tables after product stock changes"</li>
                <li>‚úÖ "Start indexing on schedule" configurado</li>
            </ul>
            <p><strong>Importante:</strong> N√£o mexeremos com estoque dos produtos de destino durante a sincroniza√ß√£o!</p>
        </div>
        
        <div class="sincronizador-wc-card">
            <h3>üë• Lojistas para Sincroniza√ß√£o</h3>
            <p>Clique em "üîÑ Sincronizar" para testar o sistema SKU-based:</p>
            
            <div class="lojista-row">
                <div class="lojista-info">
                    <h4>üè™ Loja Principal</h4>
                    <p>https://loja-principal.exemplo.com | Status: Ativo | 234 produtos</p>
                </div>
                <button class="sync-btn btn-sincronizar" data-lojista="1" title="Sincronizar produtos por SKU">
                    üîÑ Sincronizar
                </button>
            </div>
            
            <div class="lojista-row">
                <div class="lojista-info">
                    <h4>üõí Marketplace</h4>
                    <p>https://marketplace.exemplo.com | Status: Ativo | 156 produtos</p>
                </div>
                <button class="sync-btn btn-sincronizar" data-lojista="2" title="Sincronizar produtos por SKU">
                    üîÑ Sincronizar
                </button>
            </div>
            
            <div class="lojista-row">
                <div class="lojista-info">
                    <h4>üè¨ Filial Regional</h4>
                    <p>https://filial.exemplo.com | Status: Pausado | 89 produtos</p>
                </div>
                <button class="sync-btn btn-sincronizar" data-lojista="3" title="Sincronizar produtos por SKU">
                    üîÑ Sincronizar
                </button>
            </div>
        </div>
        
        <div class="sincronizador-wc-card" style="margin-top: 30px;">
            <h3>üß™ Testes Adicionais</h3>
            <button id="test-modal" class="button button-primary">üéØ Testar Modal de Progresso</button>
            <button id="test-relatorio" class="button button-secondary" style="margin-left: 10px;">üìä Testar Relat√≥rio</button>
            <button id="test-paginacao" class="button button-secondary" style="margin-left: 10px;">üìÑ Testar Pagina√ß√£o</button>
            <button id="clear-debug" class="button button-small" style="margin-left: 10px;">üóëÔ∏è Limpar Debug</button>
        </div>
        
        <div id="debug-panel" class="debug-panel">
            <div style="color: #569cd6;">[SISTEMA] Aguardando intera√ß√µes no servidor http://127.0.0.1:5500/</div>
        </div>
    </div>

    <script>
        // Configurar ambiente WordPress simulado
        window.SincronizadorWC = {
            ajaxurl: '/wp-admin/admin-ajax.php',
            nonce: 'live-test-nonce-123',
            strings: {
                confirmDelete: 'Tem certeza que deseja remover?',
                loading: 'Carregando...',
                error: 'Erro na requisi√ß√£o',
                success: 'Sincroniza√ß√£o realizada com sucesso!'
            },
            showNotice: function(message, type = 'info') {
                debugLog(`[NOTICE-${type.toUpperCase()}] ${message}`, type);
            },
            formatPrice: function(price) {
                return parseFloat(price || 0).toFixed(2).replace(".", ",");
            }
        };
        
        // Sistema de debug aprimorado
        function debugLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const panel = $('#debug-panel');
            
            const colors = {
                info: '#569cd6',
                success: '#4ec9b0',
                error: '#f44747',
                warning: '#dcdcaa',
                sync: '#c586c0'
            };
            
            const entry = `<div style="color: ${colors[type] || colors.info}; margin: 2px 0;">[${timestamp}] ${message}</div>`;
            panel.append(entry);
            panel.scrollTop(panel[0].scrollHeight);
        }
        
        // Simular produtos realistas para teste
        const produtosTesteSKU = [
            { id: 1, nome: 'üì± iPhone 15 Pro', sku: 'APPLE-IP15PRO-128', preco: '7999.90', estoque: 15 },
            { id: 2, nome: 'üíª MacBook Air M2', sku: 'APPLE-MBA-M2-256', preco: '9999.90', estoque: 8 },
            { id: 3, nome: '‚åö Apple Watch S9', sku: 'APPLE-AWS9-45MM', preco: '3999.90', estoque: 22 },
            { id: 4, nome: 'üéß AirPods Pro 2', sku: 'APPLE-APP-2GEN', preco: '2299.90', estoque: 35 },
            { id: 5, nome: 'üì± Samsung Galaxy S24', sku: 'SAMSUNG-GS24-256', preco: '6999.90', estoque: 18 }
        ];
        
        // Interceptar requisi√ß√µes AJAX para simular resposta do servidor
        $.ajaxPrefilter(function(options) {
            if (options.url && options.url.includes('admin-ajax.php')) {
                const data = options.data || '';
                debugLog(`[AJAX] Interceptando: ${data}`, 'sync');
                
                // Simular delay da requisi√ß√£o
                setTimeout(() => {
                    if (data.includes('action=sincronizar_produtos')) {
                        simularSincronizacao();
                    }
                }, 100);
                
                return false; // Cancelar requisi√ß√£o real
            }
        });
        
        // Simular processo de sincroniza√ß√£o completo
        function simularSincronizacao() {
            debugLog('üöÄ Iniciando sincroniza√ß√£o SKU-based...', 'sync');
            
            // Simular busca por produtos
            setTimeout(() => {
                debugLog(`üì¶ Encontrados ${produtosTesteSKU.length} produtos para sincronizar`, 'info');
                
                // Simular processo de matching por SKU
                produtosTesteSKU.forEach((produto, index) => {
                    setTimeout(() => {
                        debugLog(`üîç Verificando SKU: ${produto.sku}`, 'info');
                        
                        // Simular diferentes cen√°rios
                        const cenarios = ['criado', 'atualizado', 'ignorado'];
                        const resultado = cenarios[Math.floor(Math.random() * cenarios.length)];
                        
                        setTimeout(() => {
                            switch(resultado) {
                                case 'criado':
                                    debugLog(`‚úÖ Produto criado: ${produto.nome} (SKU: ${produto.sku})`, 'success');
                                    break;
                                case 'atualizado':
                                    debugLog(`üîÑ Produto atualizado: ${produto.nome} (SKU: ${produto.sku})`, 'warning');
                                    break;
                                case 'ignorado':
                                    debugLog(`‚è≠Ô∏è Produto j√° existe: ${produto.nome} (SKU: ${produto.sku})`, 'info');
                                    break;
                            }
                        }, 200);
                        
                    }, index * 800);
                });
                
                // Finalizar sincroniza√ß√£o
                setTimeout(() => {
                    const criados = Math.floor(Math.random() * 3) + 1;
                    const atualizados = Math.floor(Math.random() * 2) + 1;
                    const ignorados = produtosTesteSKU.length - criados - atualizados;
                    
                    debugLog(`üéâ Sincroniza√ß√£o conclu√≠da! Criados: ${criados}, Atualizados: ${atualizados}, Ignorados: ${ignorados}`, 'success');
                    
                    // Mostrar relat√≥rio final
                    setTimeout(() => {
                        mostrarRelatorioFinal({
                            produtos_sincronizados: produtosTesteSKU.length,
                            produtos_criados: criados,
                            produtos_atualizados: atualizados,
                            produtos_ignorados: ignorados,
                            tempo_execucao: '12.5s'
                        });
                    }, 1000);
                    
                }, produtosTesteSKU.length * 800 + 1000);
                
            }, 500);
        }
        
        // Mostrar relat√≥rio final da sincroniza√ß√£o
        function mostrarRelatorioFinal(dados) {
            const relatorio = `
                <div id="modal-relatorio" class="modal-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999; display: flex; align-items: center; justify-content: center;">
                    <div class="modal-content" style="background: white; padding: 30px; border-radius: 8px; max-width: 500px; width: 90%;">
                        <div class="modal-header" style="border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 20px;">
                            <h3 style="margin: 0; color: #333;">üìä Relat√≥rio de Sincroniza√ß√£o SKU-Based</h3>
                            <button class="modal-close" onclick="$('#modal-relatorio').remove();" style="float: right; background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
                                <div style="text-align: center; padding: 15px; background: #e7f3ff; border-radius: 6px;">
                                    <div style="font-size: 24px; font-weight: bold; color: #007cba;">${dados.produtos_sincronizados}</div>
                                    <div style="font-size: 12px; color: #666;">Total Processados</div>
                                </div>
                                <div style="text-align: center; padding: 15px; background: #e7f8e7; border-radius: 6px;">
                                    <div style="font-size: 24px; font-weight: bold; color: #28a745;">${dados.produtos_criados}</div>
                                    <div style="font-size: 12px; color: #666;">Produtos Criados</div>
                                </div>
                                <div style="text-align: center; padding: 15px; background: #fff3cd; border-radius: 6px;">
                                    <div style="font-size: 24px; font-weight: bold; color: #856404;">${dados.produtos_atualizados}</div>
                                    <div style="font-size: 12px; color: #666;">Produtos Atualizados</div>
                                </div>
                                <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 6px;">
                                    <div style="font-size: 24px; font-weight: bold; color: #6c757d;">${dados.produtos_ignorados}</div>
                                    <div style="font-size: 12px; color: #666;">Produtos Ignorados</div>
                                </div>
                            </div>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; text-align: center;">
                                <strong>‚è±Ô∏è Tempo de execu√ß√£o:</strong> ${dados.tempo_execucao}
                            </div>
                            <div style="margin-top: 15px; padding: 15px; background: #d1ecf1; border-radius: 6px;">
                                <strong>‚úÖ Sincroniza√ß√£o SKU-based conclu√≠da com sucesso!</strong><br>
                                <small>Os produtos foram sincronizados baseado no SKU, sem afetar o estoque dos produtos de destino.</small>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            $('body').append(relatorio);
            debugLog('üìä Relat√≥rio de sincroniza√ß√£o exibido', 'success');
        }
        
        // Event listeners do sistema
        $(document).ready(function() {
            debugLog('üöÄ Sistema de teste carregado no servidor http://127.0.0.1:5500/', 'success');
            debugLog('‚öôÔ∏è Configura√ß√µes WooCommerce API aceitas - √≠ndices autom√°ticos desabilitados', 'info');
            debugLog('üì¶ Sistema SKU-based ativo - n√£o modificar√° estoque de destino', 'info');
            
            // Event listeners para bot√µes de sincroniza√ß√£o
            $('.btn-sincronizar').click(function(e) {
                e.preventDefault();
                const lojista = $(this).data('lojista');
                const lojistaName = $(this).closest('.lojista-row').find('h4').text();
                
                debugLog(`üéØ Sincroniza√ß√£o iniciada para: ${lojistaName} (ID: ${lojista})`, 'warning');
                
                $(this).prop('disabled', true).text('‚è≥ Sincronizando...');
                
                // Simular sincroniza√ß√£o
                simularSincronizacao();
                
                // Re-habilitar bot√£o ap√≥s processo
                setTimeout(() => {
                    $(this).prop('disabled', false).text('üîÑ Sincronizar');
                }, 8000);
            });
            
            // Testes adicionais
            $('#test-modal').click(function() {
                debugLog('üéØ Testando modal de progresso...', 'info');
                // Implementar teste de modal se necess√°rio
            });
            
            $('#test-relatorio').click(function() {
                debugLog('üìä Testando relat√≥rio...', 'info');
                mostrarRelatorioFinal({
                    produtos_sincronizados: 15,
                    produtos_criados: 8,
                    produtos_atualizados: 5,
                    produtos_ignorados: 2,
                    tempo_execucao: '8.3s'
                });
            });
            
            $('#test-paginacao').click(function() {
                debugLog('üìÑ Sistema de pagina√ß√£o implementado nos arquivos principais', 'info');
                debugLog('üìÑ Veja admin-scripts.js linha 180+ para fun√ß√£o renderProdutos()', 'info');
            });
            
            $('#clear-debug').click(function() {
                $('#debug-panel').html('<div style="color: #569cd6;">[SISTEMA] Debug limpo</div>');
            });
            
            debugLog('‚úÖ Todos os event listeners configurados', 'success');
        });
    </script>
</body>
</html>
